# Agent 前端功能测试指南

## 前置条件

1. 启动 Terre 后端：
```bash
cd packages/terre2
yarn start:dev
```

2. 启动 Terre 前端（另一个终端）：
```bash
cd packages/origine2
yarn dev
```

3. 在浏览器中打开 Terre（通常是 http://localhost:5173）

## 测试步骤

### 1. 进入 Agent 模式

1. 打开任意游戏项目
2. 点击底部工具栏的 **"智能助手"** 按钮（机器人图标）
3. 应该看到 AgentPanel 界面

### 2. 连接 MCP

1. 点击 **"连接"** 按钮
2. 输入项目根路径（例如：`/Users/fankex/Developer/webgal_agent/WebGAL_Terre/packages/terre2/assets/templates/WebGAL_Template`）
3. 点击 **"确认"**
4. 等待连接成功
5. 应该看到：
   - 状态指示器变为绿色 **"已连接"**
   - 显示项目根路径
   - 显示 **"可用工具: 10"**

### 3. 读取场景

1. 在左侧面板选择一个场景（例如 `start.txt`）
2. 在 Agent 面板中，目标文件应该自动填充为 `game/scene/start.txt`
3. 点击 **"读取场景"** 按钮
4. 应该看到：
   - 内容区域填充了场景内容
   - 结果区域显示文件大小和编码

### 4. Dry-run 预览

1. 在内容区域修改场景内容（例如添加一行 `:测试内容;`）
2. 点击 **"Dry-run"** 按钮
3. 应该看到：
   - Diff 视图显示变更
   - 删除的行显示为红色（带 `-` 前缀）
   - 新增的行显示为绿色（带 `+` 前缀）

### 5. Apply 写入

1. 确认 Diff 无误后，点击 **"Apply"** 按钮
2. 应该看到：
   - 写入成功消息
   - 显示快照 ID（例如 `snap_20251102T221234_abc123`）
   - 显示写入字节数

### 6. 脚本校验

1. 点击 **"校验"** 按钮
2. 应该看到：
   - 如果脚本有效：显示 **"校验通过"** 和 **"未发现问题"**
   - 如果有错误：显示诊断列表，包括行号、类型、消息、建议

### 7. 资源列表

1. 点击 **"资源列表"** 按钮
2. 应该看到：
   - 背景列表
   - 立绘列表
   - BGM 列表
   - 语音列表
   - 场景列表
   - 每个分类显示资源数量

### 8. 错误处理

1. 尝试读取不存在的文件：
   - 修改目标文件为 `game/scene/nonexistent.txt`
   - 点击 **"读取场景"**
   - 应该看到错误提示：`E_NOT_FOUND: 文件未找到`

2. 尝试 Apply 冲突：
   - 执行 Dry-run
   - 在外部修改文件
   - 点击 Apply
   - 应该看到错误提示：`E_CONFLICT: 冲突` 和重试建议

### 9. 断开连接

1. 点击 **"断开"** 按钮
2. 应该看到：
   - 状态指示器变为灰色 **"未连接"**
   - 显示 **"请先连接到项目"** 提示

## 预期结果

- ✅ 所有操作按钮正常工作
- ✅ 状态指示器正确反映连接状态
- ✅ Diff 视图正确显示变更
- ✅ 错误提示清晰且包含建议
- ✅ 资源列表正确分类显示
- ✅ 脚本校验显示诊断信息
- ✅ 左侧 Scenes/Assets 面板不受影响
- ✅ 预览区域不受影响

## 已知限制

1. 目前不支持预览场景（preview_scene 工具）
2. 不支持搜索文件（search_files 工具）
3. 不支持替换文件内容（replace_in_file 工具）
4. 这些功能可以在后续版本中添加

## 故障排查

### 连接失败

1. 检查后端是否正常运行（`yarn start:dev`）
2. 检查项目根路径是否正确
3. 检查 mcp-webgal 是否已构建（`cd webgal_agent/packages/mcp-webgal && yarn build`）

### 工具调用失败

1. 打开浏览器开发者工具查看网络请求
2. 检查后端日志（terre2 终端）
3. 检查 MCP 进程日志（如果有）

### 样式问题

1. 清除浏览器缓存
2. 重新构建前端（`yarn build`）
3. 检查 SCSS 模块是否正确导入

