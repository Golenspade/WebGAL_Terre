# Agent 前端修复验证清单

## 修复内容总结

根据代码评审，已修复以下 4 个必须修正的问题：

### 1. ✅ 读取结果字段名不一致
- **问题**: 后端返回 `bytes`，前端定义为 `size`
- **修复**: 
  - `ReadFileResponse`: `size` → `bytes`，添加 `path` 字段
  - `AgentResults.tsx`: 显示 `result.data.bytes`
- **验证**: 读取文件后，应正确显示文件大小（如 "大小: 1234 bytes"）

### 2. ✅ 默认场景路径去重扩展名
- **问题**: `currentScene` 可能已包含 `.txt`，拼接时会变成 `start.txt.txt`
- **修复**: 检查是否已有扩展名，避免重复
- **验证**: 选择场景后，目标路径应为 `game/scene/start.txt`（不是 `start.txt.txt`）

### 3. ✅ 校验诊断的 kind 命名
- **问题**: 后端返回 `style` 类型，前端未映射
- **修复**: 
  - 添加 `style: t\`风格/样式\`` 映射
  - 添加 `.kind-style` 样式（蓝色）
- **验证**: 校验脚本时，如果有 `style` 类型诊断，应显示"风格/样式"标签

### 4. ✅ 错误码覆盖
- **问题**: 缺少 `E_DENY_PATH` 错误码映射
- **修复**: 添加 `E_DENY_PATH: t\`路径禁止\``
- **验证**: 尝试访问沙箱外路径时，应显示"路径禁止"错误

---

## 验收测试步骤

### 前置条件

1. 后端运行中（Terminal 96）
2. 前端运行中（Terminal 102，http://localhost:3002）
3. 浏览器打开 http://localhost:3002

### 测试 1: 读取结果字段（修复 #1）

**步骤**:
1. 进入 Agent 模式
2. 连接到项目根：`/Users/fankex/Developer/webgal_agent/WebGAL_Terre/packages/terre2/assets/templates/WebGAL_Template`
3. 选择场景 `start.txt`
4. 点击 **"读取场景"**

**预期结果**:
- ✅ 内容区域填充场景内容
- ✅ 结果区域显示：
  - "文件已读取"
  - "大小: XXX bytes"（显示实际字节数，不是空或 undefined）
  - "编码: utf-8"

**失败标志**:
- ❌ 显示 "大小: undefined bytes"
- ❌ 显示 "大小: NaN bytes"

---

### 测试 2: 默认路径扩展名（修复 #2）

**步骤**:
1. 在左侧面板选择场景 `start.txt`
2. 观察 Agent 面板中的"目标文件"输入框

**预期结果**:
- ✅ 目标文件显示：`game/scene/start.txt`
- ✅ 不是 `game/scene/start.txt.txt`

**失败标志**:
- ❌ 显示 `game/scene/start.txt.txt`

---

### 测试 3: 校验诊断 kind（修复 #3）

**步骤**:
1. 创建一个包含风格问题的场景（或使用现有场景）
2. 点击 **"校验"** 按钮

**预期结果**:
- ✅ 如果有 `syntax` 类型诊断：显示"语法错误"标签（红色）
- ✅ 如果有 `resource` 类型诊断：显示"资源错误"标签（黄色）
- ✅ 如果有 `style` 类型诊断：显示"风格/样式"标签（蓝色）
- ✅ 如果有 `warning` 类型诊断：显示"警告"标签（橙色）

**失败标志**:
- ❌ `style` 类型显示为原始字符串 "style"
- ❌ `style` 类型没有蓝色样式

**注意**: 如果当前场景没有 `style` 类型诊断，可以暂时跳过此测试，或手动创建一个包含风格问题的场景。

---

### 测试 4: 错误码覆盖（修复 #4）

**步骤**:
1. 尝试读取沙箱外的文件：
   - 修改目标文件为：`../../../etc/passwd`
   - 点击 **"读取场景"**

**预期结果**:
- ✅ 显示错误提示条
- ✅ 错误码：`E_DENY_PATH`
- ✅ 错误标题：**"路径禁止"**
- ✅ 错误消息包含具体原因

**失败标志**:
- ❌ 显示 "错误: E_DENY_PATH"（未映射标题）
- ❌ 没有错误提示

**备选测试**（如果沙箱未启用）:
- 尝试读取不存在的文件：`game/scene/nonexistent.txt`
- 应显示 `E_NOT_FOUND: 文件未找到`

---

## 完整工作流测试

### 测试 5: 读取 → Dry-run → Apply → 校验

**步骤**:
1. 读取场景 `start.txt`
2. 在内容区域添加一行：`:测试内容;`
3. 点击 **"Dry-run"**
4. 确认 Diff 显示正确（绿色新增行）
5. 点击 **"Apply"**
6. 确认显示快照 ID（如 `snap_20251102T221234_abc123`）
7. 点击 **"校验"**
8. 确认校验通过或显示诊断

**预期结果**:
- ✅ 每一步都成功
- ✅ Diff 显示正确
- ✅ Apply 返回 snapshotId 和 bytesWritten
- ✅ 校验显示结果

---

### 测试 6: 冲突处理（E_CONFLICT）

**步骤**:
1. 读取场景 `start.txt`
2. 修改内容并点击 **"Dry-run"**
3. **在外部编辑器中修改同一文件**（模拟冲突）
4. 点击 **"Apply"**

**预期结果**:
- ✅ 显示错误提示条
- ✅ 错误码：`E_CONFLICT`
- ✅ 错误标题：**"冲突"**
- ✅ 错误提示包含重试建议

---

### 测试 7: 资源列表

**步骤**:
1. 点击 **"资源列表"** 按钮

**预期结果**:
- ✅ 显示资源分类：
  - 背景 (backgrounds)
  - 立绘 (figures)
  - BGM (bgm)
  - 语音 (vocals)
  - 场景 (scenes)
- ✅ 每个分类显示资源数量
- ✅ 资源以网格布局显示

---

## 验收标准

所有测试通过后，Stage 3.2.2 - Frontend 验收完成：

- [x] 修复 #1: 读取结果字段正确显示
- [x] 修复 #2: 默认路径无重复扩展名
- [x] 修复 #3: 校验诊断 kind 完整映射
- [x] 修复 #4: 错误码完整覆盖
- [x] 完整工作流正常运行
- [x] 错误处理符合预期
- [x] 资源列表正确显示

---

## 已知限制

以下功能暂未实现（可在后续版本添加）：

1. 预览场景（preview_scene 工具）
2. 搜索文件（search_files 工具）
3. 替换文件内容（replace_in_file 工具）
4. Apply 成功后复制 snapshotId 按钮
5. E_CONFLICT 时的"重新 Dry-run"快捷按钮
6. 按钮级 loading spinner

---

## 故障排查

### 前端未更新

如果修改未生效，尝试：
1. 清除浏览器缓存（Cmd+Shift+R 强制刷新）
2. 重启前端开发服务器（Terminal 102）
3. 检查浏览器控制台是否有错误

### 后端错误

如果 API 调用失败，检查：
1. 后端是否正常运行（Terminal 96）
2. 网络请求状态码（浏览器开发者工具 → Network）
3. 后端日志（Terminal 96 输出）

### MCP 连接失败

如果无法连接 MCP，检查：
1. mcp-webgal 是否已构建：`cd webgal_agent/packages/mcp-webgal && yarn build`
2. 项目根路径是否正确
3. 后端日志中的错误信息

